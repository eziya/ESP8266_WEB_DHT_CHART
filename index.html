<!DOCTYPE html>
<html>

<head>
  <title>Temp+Humdity Monitoring</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/js/bootstrap-datetimepicker.min.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/css/bootstrap-datetimepicker.min.css">
  
  <script src="http://code.highcharts.com/highcharts.js"></script>
  <script src="http://code.highcharts.com/modules/exporting.js"></script>   
  
  <style> .the-table {
    table-layout: fixed;
    word-wrap: break-word;
    }
  </style>
</head>

<body >
  <div class="container">
    <div class="jumbotron">
      <h1>Temp.+Humidity Monitoring System</h1>
      <p>Please use below URLs to use monitor temperature and humidity</p>
    </div>
    <div class="col-md-12">
      <h3>Current temperature &amp; humidity</h3>
      <table class="table-responsive table-condensed">
        <tbody>
          <tr>
            <td><img class="img-responsive" src="temp.png" alt="temperature and humidity" width="100" height="100"></td>
            <td>
              <h1 class="current-temperature">20<small>℃</small>
              </h1>
            </td>
            <td style="width: 20px"></td>
            <td><img class="img-responsive" src="humid.png" alt="temperature and humidity" width="100" height="100"></td>
            <td>
              <h1 class="current-humidity">45<small>%</small>
              </h1>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="col-md-12">
      <div>
        <div class="col-md-6" id="chartTemp" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
        <div class="col-md-6" id="chartHumid" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
      </div>
      <div class="col-md-8">
        <form action="" class="form-horizontal" role="form">
          <div class="form-group">
            <div class='input-group date' id='datetimepicker1' data-link-field="dtp_input1">
              <input id='datepicker-input' type='text' class="form-control"/>
              <span class="input-group-addon">
              	<span class="glyphicon glyphicon-calendar"></span>
              </span>
            </div>
            <input type="hidden" id="dtp_input1" value=""><br>
          </div>
        </form>
      </div>
    </div>
    <div class="col-md-12">
      <h2>Sample URLs</h2>
      <table class="table-responsive table-striped table-bordered table-condensed the-table">
        <tbody>
          <tr>
            <th>Data type</th>
            <th>URL</th>
          </tr>
          <tr>
            <td>Current temperature</td>
            <td><a href="temperature/current">http://xxx.xxx.xxx.xxx:8888/temperature/current</a></td>
          </tr>
          <tr>
            <td>Daily temperature</td>
            <td><a href="temperature/20181117">http://xxx.xxx.xxx.xxx:8888/temperature/[yyyyMMdd]</a></td>
          </tr>
          <tr>
            <td>Current humidity</td>
            <td><a href="humidity/current">http://xxx.xxx.xxx.xxx:8888/humidity/current</a></td>
          </tr>
          <tr>
            <td>Daily humidity</td>
            <td><a href="humidity/20181117">http://xxx.xxx.xxx.xxx:8888/humidity/[yyyyMMdd]</a></td>
          </tr>
        </tbody>
      </table>
      <br>
      <div class="col-md-4 alert alert-warning alert-dismissable fade in">
        <a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
        <strong>*</strong>[yyyyMMdd] should be replaced with date string such as 20180101
      </div>
    </div>
    <!--
    <div class="col-md-12">
        <h2>Videos</h2>
        <div class="embed-responsive embed-responsive-16by9">
            <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/qrVEgOBC_E0"></iframe>
        </div>
    </div>
    -->
  </div>
   
  <script type="text/javascript">
    var chartTemp = null;
    var chartHumid = null;

    function initDatePicker() {
      $('#datetimepicker1').datetimepicker({
        format: 'YYYY-MM-DD'
      });
      
      $('#datetimepicker1').datetimepicker().on('changeDate', function(ev) {
        print('renderChart');
        renderChart();
      });
    }

    function initChart() {
      var optionsTemp = {
        chart: {
          type: 'area'
        },
        title: {
          text: 'Daily temperature'
        },
        /*subtitle: {
         text: ''
         },*/
        xAxis: {
          allowDecimals: false,
          labels: {
            formatter: function() {
              return this.value; // clean, unformatted number for year
            }
          }
        },
        yAxis: {
          title: {
            text: 'Temperature(℃)'
          },
          labels: {
            formatter: function() {
              return this.value;
            }
          }
        },
        tooltip: {
          pointFormat: '<b>{point.y:,.1f}</b>'
        },
        series: [{
          name: 'Temperature',
          color: '#FF6600',
          data: []
        }]
      };
      var optionsHumid = {
        chart: {
          type: 'area'
        },
        title: {
          text: 'Daily humidity'
        },
        /*subtitle: {
         text: ''
         },*/
        xAxis: {
          allowDecimals: false,
          labels: {
            formatter: function() {
              return this.value; // clean, unformatted number for year
            }
          }
        },
        yAxis: {
          title: {
            text: 'Humidity(%)'
          },
          labels: {
            formatter: function() {
              return this.value;
            }
          }
        },
        tooltip: {
          pointFormat: '<b>{point.y:,.1f}</b>'
        },
        series: [{
          name: 'Humidity',
          data: []
        }]
      };
      chartTemp = new Highcharts.chart('chartTemp', optionsTemp);
      chartHumid = new Highcharts.chart('chartHumid', optionsHumid);
    }

    function initTempHumidity() {
      $.ajax({
        url: '/temperature/current',
        success: function(data) {
          if (data.length > 0) $('.current-temperature').html(data[0].value + '<small> ℃</small>');
        }
      });
      $.ajax({
        url: '/humidity/current',
        success: function(data) {
          if (data.length > 0) $('.current-humidity').html(data[0].value + '<small> %</small>');
        }
      });
    }

    function renderChart() {
      var dateInput = $('#datepicker-input').val();
      var dateInput = dateInput.replace(/-/gi, "");
      $.ajax({
        url: '/temperature/' + dateInput,
        success: function(data) {
          var arrCollectTm = $.map(data, function(item, index) {
            var tempDate = new Date(item.collect_tm);
            //"Fri Nov 18 2016 09:25:38 GMT+0900 (대한민국 표준시)"
            var localdate = tempDate.toString().split(" ")[4];
            return [localdate];
          });
          var arrValue = $.map(data, function(item, index) {
            return [Number(item.value)];
          });
          chartTemp.xAxis[0].setCategories(arrCollectTm);
          chartTemp.series[0].setData(arrValue);
        }
      });
      $.ajax({
        url: '/humidity/' + dateInput,
        success: function(data) {
          var arrCollectTm = $.map(data, function(item, index) {
            var tempDate = new Date(item.collect_tm);
            //"Fri Nov 18 2016 09:25:38 GMT+0900 (대한민국 표준시)"
            var localdate = tempDate.toString().split(" ")[4];
            return [localdate];
          });
          var arrValue = $.map(data, function(item, index) {
            return [Number(item.value)];
          });
          chartHumid.xAxis[0].setCategories(arrCollectTm);
          chartHumid.series[0].setData(arrValue);
        }
      });
    }
    
    $(document).ready(function() {
      initDatePicker();
      initTempHumidity();
      initChart();
      renderChart();
    });
  </script>  
</body>
</html>
